nextflow.enable.dsl=2

// create parameters (can be altered via command line)
params {
    fastq_dir = null
    output_dir = null
    ref_dir = null
    metadata = null
    cpus = 30
    help = false

    // testing environment parameters
    test_mode = false
}

manifest {
    name = 'WESley-data-processing'
    description = 'WES data processing as described by GATK best practices'
    nextflowVersion = '>=25.04.6'
    author = 'Dien Ethan Mach'
    mainScript = 'data_processing.nf'
    homePage = 'https://github.com/e10m/WESley'
}

process {
    containerOptions = "-v ${params.ref_dir}:/references"
    errorStrategy = { task.attempt <= task.maxRetries ? 'retry' : 'ignore' }
    maxRetries = 3

    // CPU labels (static - CPUs don't scale with retries)
    withLabel: 'highCpu' { cpus = params.cpus }
    withLabel: 'medCpu' { cpus = 8 }
    withLabel: 'lowCpu' { cpus = 1 }

    // Memory labels (dynamic - scale 20% per retry)
    withLabel: 'extraHighMem' { memory = { 50.GB * Math.pow(1.2, task.attempt - 1) } }
    withLabel: 'highMem' { memory = { 34.GB * Math.pow(1.2, task.attempt - 1) } }
    withLabel: 'medMem' { memory = { 10.GB * Math.pow(1.2, task.attempt - 1) } }
    withLabel: 'lowMem' { memory = { 1.GB * Math.pow(1.2, task.attempt - 1) } }

    // Time labels (dynamic - scale 20% per retry)
    withLabel: 'extraLongTime' { time = { 8.h * Math.pow(1.2, task.attempt - 1) } }
    withLabel: 'longTime' { time = { 2.h * Math.pow(1.2, task.attempt - 1) } }
    withLabel: 'medTime' { time = { 75.m * Math.pow(1.2, task.attempt - 1) } }
    withLabel: 'shortTime' { time = { 1.m * Math.pow(1.2, task.attempt - 1) } }

    withName: TRIM {
        container = 'quay.io/biocontainers/trim-galore:0.6.6--0'
    }
    withName: SPLIT {
        container = 'quay.io/biocontainers/bbmap:38.06--0'
    }
    withName: BWA_ALIGN {
        container = 'e10m/bwa-and-samtools:latest'
    }
    withName: MARK_DUPES {
        container = 'broadinstitute/gatk:4.2.0.0'
        containerOptions = "-v ${params.output_dir}:/output_dir -v ${params.ref_dir}:/references -u root"
    }
    withName: SET_TAGS {
        container = 'broadinstitute/gatk:4.2.0.0'
        containerOptions = "-v ${params.output_dir}:/output_dir -v ${params.ref_dir}:/references -u root"
    }
    withName: RECAL_BASES {
        container = 'broadinstitute/gatk:4.2.0.0'
        containerOptions = "-v ${params.output_dir}:/output_dir -v ${params.ref_dir}:/references -u root"
    }
    withName: APPLY_BQSR {
        container = 'broadinstitute/gatk:4.2.0.0'
        containerOptions = "-v ${params.output_dir}:/output_dir -v ${params.ref_dir}:/references -u root"
    }
    withName: FASTQC {
        container = 'biocontainers/fastqc:v0.11.9_cv8'
    }
    withName: MULTIQC {
        container = 'multiqc/multiqc:v1.30'
    }
    withName: CALC_COVERAGE {
        container = 'broadinstitute/gatk:4.2.0.0'
    }
}

// Profiles for different execution environments
profiles {
    local {
        process.executor = 'local'
    }
}

docker {
    enabled = true
    runOptions = '-u $(id -u):$(id -g)'
}