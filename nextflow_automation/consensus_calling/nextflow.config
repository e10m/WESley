nextflow.enable.dsl=2

// create parameters (can be altered via command line)
params {
    base_dir = null
    ref_dir = null
    cpus = 30
    help = false
}

manifest {
    name = 'WESley-mutation-calling'
    description = 'Somatic variant calling using up to 3 variant callers (Mutect2, MuSE, Varscan2)'
    nextflowVersion = '>=25.04.6'
    author = 'Dien Ethan Mach'
    mainScript = 'mutation_calling.nf'
    homePage = 'https://github.com/e10m/WESley'
}

process {
    executor = 'local'
    containerOptions = "-v ${params.ref_dir}:/references"
    errorStrategy = 'retry'
    maxRetries = 3

    // CPU labels (static - CPUs don't scale with retries)
    withLabel: 'highCpu' { cpus = params.cpus }
    withLabel: 'medCpu' { cpus = 4 }
    withLabel: 'lowCpu' { cpus = 1 }

    // Memory labels (dynamic - scale 20% per retry)
    withLabel: 'extraHighMem' { memory = { 50.GB * Math.pow(1.2, task.attempt - 1) } }
    withLabel: 'highMem' { memory = { 34.GB * Math.pow(1.2, task.attempt - 1) } }
    withLabel: 'medMem' { memory = { 10.GB * Math.pow(1.2, task.attempt - 1) } }
    withLabel: 'lowMem' { memory = { 1.GB * Math.pow(1.2, task.attempt - 1) } }

    // Time labels (dynamic - scale 20% per retry)
    withLabel: 'extraLongTime' { time = { 24.h * Math.pow(1.2, task.attempt - 1) } }
    withLabel: 'longTime' { time = { 6.h * Math.pow(1.2, task.attempt - 1) } }
    withLabel: 'medTime' { time = { 2.h * Math.pow(1.2, task.attempt - 1) } }
    withLabel: 'shortTime' { time = { 5.m * Math.pow(1.2, task.attempt - 1) } }

    withName: SORT_VCFS {
        container = "broadinstitute/gatk:4.2.0.0"
    }
    withName: REHEADER {
        container = "staphb/bcftools:1.10.2"
    }
    withName: INDEX {
        container = "quay.io/biocontainers/samtools:1.10--h9402c20_1"
    }
    withName: INTERSECT {
        container = "staphb/bcftools:1.10.2"
    }
    withName: MERGE_VCFS {
        container = "broadinstitute/gatk:4.2.0.0"
    }
    withName: NORM_INDELS {
        container = "staphb/bcftools:1.10.2"
    }
    withName: VEP {
        container = 'e10m/vep:106.1'
    }
    withName: CREATE_MAF {
        container = 'e10m/vcf2maf:1.6.19'
    }
    withName: KEEP_NONSYNONYMOUS {
        container = 'ubuntu:20.04'
    }
    withName: RENAME_HG38 {
        container = 'ubuntu:20.04'
    }
    withName: ONCOKB {
        container = 'e10m/oncokb:3.0.0'
        containerOptions = "-v ${params.ref_dir}:/references --env ONCOKB_TOKEN"
    }
}

docker {
    enabled = true
    runOptions = '--user $(id -u):$(id -g)'
}