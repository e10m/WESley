nextflow_process {

    name "Test Process FILTER_MUTECT_CALLS"
    script "../../../../mutation_calling/modules/mutect2/filter_mutect_calls.nf"
    process "FILTER_MUTECT_CALLS"
    config "../../../shared-test.config"

    test("Should filter paired mutect2 variant calls w/o failing") {

        when {
            params {
                test_data = "${projectDir}/test-data"
                references = "${projectDir}/test-data/references"
                test_mode = true
            }

            process {
                """
                input[0] = [
                    'test', 
                    'testT', 
                    'testN',
                    file('${params.test_data}/vcfs/test.mutect2.paired.vcf'),
                    file('${params.test_data}/read-orientation/test.read-orientation-model.tar.gz'),
                    file('${params.test_data}/m2-stats/test.mutect2.paired.vcf.stats'),
                    file('${params.test_data}/contamination-tables/test.paired.contamination.table'),
                    file('${params.test_data}/contamination-tables/test.paired.segments.table')
                ]
                """
            }
        }

        then {
            assert process.success
            assert process.out.size() == 1

            with(process.out[0][0]) {
                assert size() == 4
                assert get(0) == 'test'
                assert get(1) == 'testT'
                assert get(2) == 'testN'
                assert file(get(3)).name == 'test.mutect2.paired.filtered.vcf'
            }
        }

    }

    test("Should handle tumor-only filtering") {

        when {
            params {
                test_data = "${projectDir}/test-data"
                references = "${projectDir}/test-data/references"
                test_mode = true
            }
            process {
                """
                input[0] = [
                    'test', 
                    'testT', 
                    'testN',
                    file('${params.test_data}/vcfs/test.mutect2.tumorOnly.vcf'),
                    file('${params.test_data}/read-orientation/test.read-orientation-model.tar.gz'),
                    file('${params.test_data}/m2-stats/test.mutect2.tumorOnly.vcf.stats'),
                    file('${params.test_data}/contamination-tables/test.tumorOnly.contamination.table'),
                    file('${params.test_data}/contamination-tables/test.tumorOnly.segments.table')
                ]
                """
            }
        }

        then {
            assert process.success
            assert process.out.size() == 1

            with(process.out[0][0]) {
                assert size() == 4
                assert get(0) == 'test'
                assert get(1) == 'testT'
                assert get(2) == 'testN'
                assert file(get(3)).name == 'test.mutect2.tumorOnly.filtered.vcf'
            }
        }

    }

}