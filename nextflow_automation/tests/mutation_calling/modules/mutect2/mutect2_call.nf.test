nextflow_process {

    name "Test Process MUTECT2_CALL"
    script "../../../../mutation_calling/modules/mutect2/mutect2_call.nf"
    process "MUTECT2_CALL"
    config "../../../shared-test.config"

    test("Should run paired calling without failures") {

        when {
            params {
                test_mode = true
                test_data = "${projectDir}/test-data/bams/chr22"
                ref_dir = "${projectDir}/test-data/references"
            }

            process {
                """
                input[0] = [
                    'test', 
                    'testT', 
                    file('${params.test_data}/test2.paired_end.sorted.bam'),
                    file('${params.test_data}/test2.paired_end.sorted.bam.bai'),
                    [],
                    'testN',
                    file('${params.test_data}/test.paired_end.sorted.bam'),
                    file('${params.test_data}/test.paired_end.sorted.bam.bai'),
                ]
                """
            }
        }

        then {
            assert process.success
            assert process.out.size() == 1

            with(process.out[0][0]) {
                assert size() == 6
                assert get(0) == 'test'
                assert get(1) == 'testT'
                assert get(2) == 'testN'
                assert file(get(3)).name == 'test.mutect2.paired.vcf'
                assert file(get(4)).name == 'test.f1r2.tar.gz'
                assert file(get(5)).name == 'test.mutect2.paired.vcf.stats'
            }
        }
    }

    test("Should run tumor-only mode without failing") {

        when {
            params {
                test_mode = true
                test_data = "${projectDir}/test-data/bams/chr22"
                ref_dir = "${projectDir}/test-data/references"
            }
            
            process {
                """
                input[0] = [
                    'test', 
                    'testT', 
                    file('${params.test_data}/test2.paired_end.sorted.bam'),
                    file('${params.test_data}/test2.paired_end.sorted.bam.bai'),
                    [],
                    'testN',
                    [],
                    []
                ]
                """
            }
        }

        then {
            assert process.success
            assert process.out.size() == 1

            with(process.out[0][0]) {
                assert size() == 6
                assert get(0) == 'test'
                assert get(1) == 'testT'
                assert get(2) == 'testN'
                assert file(get(3)).name == 'test.mutect2.tumorOnly.vcf'
                assert file(get(4)).name == 'test.f1r2.tar.gz'
                assert file(get(5)).name == 'test.mutect2.tumorOnly.vcf.stats'
            }
        }

    }
}