nextflow_process {

    name "Test Process MUTECT2_CALL"
    script "../../../../mutation_calling/modules/mutect2/mutect2_call.nf"
    process "MUTECT2_CALL"
    config "../../../shared-test.config"

    test("Should run paired calling without failures") {

        when {
            params {
                test_mode = true
                test_data = "${projectDir}/test-data/bams/chr22"
                ref_dir = "${projectDir}/test-data/references"
            }

            process {
                """
                input[0] = [
                    'test', 
                    'testT', 
                    file('${params.test_data}/test2.paired_end.sorted.bam'),
                    file('${params.test_data}/test2.paired_end.sorted.bam.bai'),
                    [],
                    'testN',
                    file('${params.test_data}/test.paired_end.sorted.bam'),
                    file('${params.test_data}/test.paired_end.sorted.bam.bai'),
                ]
                """
            }
        }

        then {
            assert process.success
            assert process.out.size() == 1  // check for final output tuple

            def output_tuple = process.out[0][0]

            // validate the outputs
            assert output_tuple.size() == 5
            assert output_tuple[0] == 'test'
            assert output_tuple[1] == 'testT'
            assert output_tuple[2] == 'testN'
            assert file(output_tuple[3]).name == 'test.unfiltered.vcf'
            assert file(output_tuple[4]).name == 'test.f1r2.tar.gz'
        }
    }

    test("Should run tumor-only mode without failing") {

        when {
            params {
                test_mode = true
                test_data = "${projectDir}/test-data/bams/chr22"
                ref_dir = "${projectDir}/test-data/references"
            }
            
            process {
                """
                input[0] = [
                    'test', 
                    'testT', 
                    file('${params.test_data}/test2.paired_end.sorted.bam'),
                    file('${params.test_data}/test2.paired_end.sorted.bam.bai'),
                    [],
                    'testN',
                    [],
                    []
                ]
                """
            }
        }

        then {
            assert process.success
            assert process.out.size() == 1  // check for final output tuple

            def output_tuple = process.out[0][0]

            // validate the outputs
            assert output_tuple.size() == 5
            assert output_tuple[0] == 'test'
            assert output_tuple[1] == 'testT'
            assert output_tuple[2] == 'testN'
            assert file(output_tuple[3]).name == 'test.unfiltered.vcf'
            assert file(output_tuple[4]).name == 'test.f1r2.tar.gz'
        }

    }
}