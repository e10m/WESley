nextflow_process {

    name "Test Process GET_PILEUP_SUMMARIES"
    script "../../../../mutation_calling/modules/mutect2/get_pileup_summaries.nf"
    process "GET_PILEUP_SUMMARIES"
    config "../../../shared-test.config"

    test("Should run paired mode") {
        when {
            params {
                test_mode = true
                test_data = "${projectDir}/test-data/bams/chr22"
                ref_dir = "${projectDir}/test-data/references"
            }
            process {
                """
                input[0] = [
                    'test', 
                    'testT', 
                    file('${params.test_data}/test2.paired_end.sorted.bam'),
                    file('${params.test_data}/test2.paired_end.sorted.bam.bai'),
                    [],
                    'testN',
                    file('${params.test_data}/test.paired_end.sorted.bam'),
                    file('${params.test_data}/test.paired_end.sorted.bam.bai')
                ]
                """
            }
        }

        then {
            assert process.success
            assert process.out.size() == 1

            def output_tuple = process.out[0][0]

            // validate outputs
            assert output_tuple.size() == 5
            assert output_tuple[0] == 'test'
            assert output_tuple[1] == 'testT'
            assert output_tuple[2] == 'testN'
            assert file(output_tuple[3]).name == 'test.tumor-pileups.table'
            assert file(output_tuple[4]).name == 'test.normal-pileups.table'
        }
    }

    test("Should run tumor-only mode") {
        when {
            params {
                test_mode = true
                test_data = "${projectDir}/test-data/bams/chr22"
                ref_dir = "${projectDir}/test-data/references"
            }
            process {
                """
                input[0] = [
                    'test', 
                    'testT', 
                    file('${params.test_data}/test2.paired_end.sorted.bam'),
                    file('${params.test_data}/test2.paired_end.sorted.bam.bai'),
                    [],
                    'testN',
                    [],
                    []
                ]
                """
            }
        }

        then {
            assert process.success
            assert process.out.size() == 1

            def output_tuple = process.out[0][0]

            // validate outputs
            assert output_tuple.size() == 5
            assert output_tuple[0] == 'test'
            assert output_tuple[1] == 'testT'
            assert output_tuple[2] == 'testN'
            assert file(output_tuple[3]).name == 'test.tumor-pileups.table'
            assert file(output_tuple[4]).name == 'test.normal-pileups.table'
        }
    }
}