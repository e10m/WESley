nextflow_process {

    name "Test Process SET_TAGS"
    script "../../../data_processing/modules/set_tags.nf"
    process "SET_TAGS"
    config "../../shared-test.config"
    config "../../../data_processing/nextflow.config"

    test("Should add the metadata tags to BAM without failures") {

        when {
            params{
                test_data = "${projectDir}/test-data"
                ref_dir = "${params.test_data}/references"
            }
            process {
                """
                input[0] = [
                    'test',
                    file("${params.test_data}/bams/chr22/test.paired_end.sorted.bam", checkIfExists: true),
                    file("${params.test_data}/bams/chr22/test.paired_end.sorted.bam.bai", checkIfExists: true)
                ]
                """
            }
        }

        then {
            assert process.success
            println("\n* Process completed successfully; metadata tags added to BAM")

            with(process.out.tagged_bams) {
                def (sample_id, bam, bai) = get(0)

                assert get(0).size() == 3
                println("\n* 3 items in output tuple")

                assert sample_id == 'test'
                println("\n* Sample ID is outputted correctly")

                assert path(bam.toString()).exists()
                assert path(bai.toString()).exists()
                println("\n* All files found and exist")
            }
        }
    }
}
